<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload and Processing</title>
</head>
<body>
    <h1>Upload and Process Image</h1>

    <!-- Image Upload Form -->
    <form id="uploadForm">
        <input type="file" id="fileInput" name="file" accept="image/*" required>
        <button type="submit" id="uploadButton">Upload Image</button>
    </form>

    <!-- Image Preview -->
    <div id="preview-section" class="hidden">
        <h2>Image Preview</h2>
        <img id="imagePreview" alt="Image Preview" />
        <select id="filterSelect">
            <option value="none">No Filter</option>
            <option value="grayscale(100%)">Grayscale</option>
            <option value="sepia(100%)">Sepia</option>
            <option value="blur(5px)">Blur</option>
        </select>
        <button id="downloadButton">Download Processed Image</button>
    </div>

    <div id="result"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const imageUpload = document.getElementById("fileInput");
            const uploadButton = document.getElementById("uploadButton");
            const previewSection = document.getElementById("preview-section");
            const imagePreview = document.getElementById("imagePreview");
            const filterSelect = document.getElementById("filterSelect");
            const downloadButton = document.getElementById("downloadButton");

            let uploadedImage = null;
            let uploadedImageURL = "";

            uploadButton.addEventListener("click", async (e) => {
                e.preventDefault();
                const file = imageUpload.files[0];
                if (file && file.type.startsWith("image/")) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedImage = e.target.result;
                        imagePreview.src = uploadedImage;
                        previewSection.classList.remove("hidden");
                    };
                    reader.readAsDataURL(file);

                    // Upload the file to the Flask app
                    const formData = new FormData();
                    formData.append("file", file);
                    try {
                        const response = await fetch("/upload", {
                            method: "POST",
                            body: formData,
                        });
                        const result = await response.json();
                        if (result.url) {
                            uploadedImageURL = result.url;
                        } else {
                            alert(result.error || "Upload failed");
                        }
                    } catch (error) {
                        console.error(error);
                    }
                } else {
                    alert("Please upload a valid image file.");
                }
            });

            filterSelect.addEventListener("change", () => {
                const filter = filterSelect.value;
                imagePreview.style.filter = filter === "none" ? "" : filter;
            });

            downloadButton.addEventListener("click", () => {
                if (uploadedImage) {
                    const link = document.createElement("a");
                    link.download = "processed-image.png";
                    link.href = imagePreview.src;
                    link.click();
                } else {
                    alert("No image to download.");
                }
            });
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });
                const result = await response.json();
                const resultDiv = document.getElementById('result');

                if (result.url) {
                    resultDiv.innerHTML = `<p>File uploaded! <a href="${result.url}" target="_blank">View Image</a></p>`;
                } else {
                    resultDiv.innerHTML = `<p>Error: ${result.error}</p>`;
                }
            } catch (error) {
                console.error(error);
            }
        });

        async function processImage(imageUrl, filterType) {
            try {
                const response = await fetch("/process", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ image_url: imageUrl, filter_type: filterType }),
                });
                const result = await response.json();
        
                if (result.url) {
                    return result.url; // Return the processed image URL
                } else {
                    alert(result.error || "Processing failed");
                    return null;
                }
            } catch (error) {
                console.error(error);
                alert("Error processing image.");
                return null;
            }
        }
    </script>
</body>
</html>
